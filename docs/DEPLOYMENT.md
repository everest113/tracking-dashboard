# Deployment Guide

This document describes the deployment workflow for the Tracking Dashboard.

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                         GitHub                                   │
├─────────────────────────────────────────────────────────────────┤
│  PR Created/Updated        Push to main                         │
│         │                       │                               │
│         ▼                       ▼                               │
│  ┌─────────────┐         ┌─────────────┐                       │
│  │   CI Jobs   │         │   CI Jobs   │                       │
│  │ - Lint      │         │ - Lint      │                       │
│  │ - Build     │         │ - Build     │                       │
│  │ - Schema    │         │ - Schema    │                       │
│  │   Check     │         │   Check     │                       │
│  │ - Test      │         │ - Test      │                       │
│  └─────────────┘         └─────────────┘                       │
│         │                       │                               │
│         ▼                       ▼                               │
│  ┌─────────────┐         ┌─────────────┐                       │
│  │   Preview   │         │  Production │                       │
│  │   Deploy    │         │   Deploy    │                       │
│  └─────────────┘         └─────────────┘                       │
└─────────────────────────────────────────────────────────────────┘
         │                       │
         ▼                       ▼
┌─────────────────┐     ┌─────────────────┐
│   Neon Branch   │     │  Neon (main)    │
│  preview/pr-XX  │     │   Production    │
└─────────────────┘     └─────────────────┘
         │                       │
         ▼                       ▼
┌─────────────────┐     ┌─────────────────┐
│ Vercel Preview  │     │ Vercel Prod     │
│ pr-XX.vercel    │     │ dash.stitchi.co │
└─────────────────┘     └─────────────────┘
```

## Environments

| Environment | Branch | Database | URL |
|-------------|--------|----------|-----|
| Production | `main` | Neon `main` branch | dash.stitchi.co |
| Preview | PR branches | Neon `preview/pr-{number}` | Auto-generated by Vercel |

## Workflows

### 1. CI (`ci.yml`)

Runs on every PR and push to main.

**Jobs:**
- **Lint** — ESLint check
- **Build** — TypeScript compilation and Next.js build
- **Schema Check** — Validates Prisma schema matches migrations (prevents drift)
- **Test** — Runs unit/integration tests against ephemeral PostgreSQL

### 2. Preview Deploy (`preview.yml`)

Runs when a PR is opened or updated.

**Steps:**
1. Creates a Neon database branch from `main`
2. Runs migrations on the preview branch
3. Comments on PR with database info
4. Vercel automatically deploys the preview

### 3. Preview Cleanup (`preview-cleanup.yml`)

Runs when a PR is closed (merged or abandoned).

**Steps:**
1. Deletes the Neon preview branch
2. Comments on PR confirming cleanup

### 4. Production Deploy (`deploy-production.yml`)

Runs when code is pushed to `main`.

**Steps:**
1. Checks if migrations changed
2. Runs migrations on production database (if needed)
3. Waits for Vercel deployment
4. Health check

## Required Secrets

Add these to GitHub repository settings → Secrets and variables → Actions:

| Secret | Description |
|--------|-------------|
| `NEON_PROJECT_ID` | Neon project ID (from Neon dashboard) |
| `NEON_API_KEY` | Neon API key (create at console.neon.tech → API keys) |
| `DATABASE_URL` | Production database URL (pooled connection string) |

## Required Variables

Add these to GitHub repository settings → Secrets and variables → Actions → Variables:

| Variable | Description |
|----------|-------------|
| `PRODUCTION_URL` | Production URL for health checks (default: `https://dash.stitchi.co`) |

## Database Migrations

### Creating a Migration

```bash
# Make changes to prisma/schema.prisma, then:
npx prisma migrate dev --name descriptive_name
```

This creates a migration file in `prisma/migrations/`.

### Migration Rules

1. **Never use `prisma db push` in production** — Always create migrations
2. **Test migrations locally first** — Run `npx prisma migrate deploy` against a test DB
3. **Schema drift check will fail CI** if you change schema without a migration
4. **Migrations are immutable** — Never edit a migration after it's been applied

### Rolling Back

Prisma doesn't support automatic rollbacks. If a migration fails:

1. Fix the issue in a new migration
2. Or manually revert the database and delete the failed migration

## Vercel Integration

The workflows assume Vercel's GitHub integration handles actual deployments. Vercel needs:

1. **Build Command:** `npm run build` (default)
2. **Install Command:** `npm ci` (default)
3. **Environment Variables:**
   - `DATABASE_URL` — Set per environment (Production vs Preview)
   
### Neon-Vercel Integration (Recommended)

For automatic preview database URLs, install the [Neon Vercel Integration](https://neon.tech/docs/guides/vercel):

1. Go to Vercel project settings → Integrations
2. Add Neon integration
3. Connect your Neon project
4. Enable "Create a branch for every preview deployment"

This automatically sets `DATABASE_URL` for each preview deployment.

## Troubleshooting

### Schema Drift Check Fails

```
❌ Schema drift detected!
```

**Fix:** Create a migration for your schema changes:
```bash
npx prisma migrate dev --name your_change_name
```

### Preview Database Not Created

Check:
1. `NEON_API_KEY` secret is set correctly
2. `NEON_PROJECT_ID` matches your Neon project
3. Neon API key has write permissions

### Production Migration Fails

1. Check the GitHub Actions log for the specific error
2. An issue will be auto-created with details
3. You may need to manually fix the database or revert

### Health Check Fails

The production URL might not be responding. Check:
1. Vercel deployment status
2. Application logs in Vercel
3. Database connectivity
